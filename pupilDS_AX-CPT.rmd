---
title: "Pupillometry and AX-CPT"
author: "Jeremy Elman"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

Load libraries
```{r results='hide', message=FALSE, warning=FALSE}
library(ggplot2)
library(gridExtra)
library(gtools)
library(lme4)
library(arm)
library(lmerTest)
library(dplyr)
library(magrittr)
library(sjPlot)
library(sjmisc)
library(multcomp)
source("K:/code/summarySE.R")
source("K:/code/normDataWithin.R")
source("K:/code/summarySEwithin.R")
sjp.setTheme(base=theme_bw())
```

Load data.
```{r}
pupilAXCPT = read.csv("K:/AX-CPT/data/pupil_AX-CPT.csv", 
                         stringsAsFactors = FALSE)
pupilAXCPT = pupilAXCPT[!is.na(pupilAXCPT$PCA) & 
                        !is.na(pupilAXCPT$rMCI_cons_v2),]
pupilAXCPT = subset(pupilAXCPT, vetsa2=='vetsa2')
str(pupilAXCPT)
```

Recode two-level factors to 0/1. Center continuous data.
*TRANSFORM*
```{r}
## Create factors
# Set 6 as reference level to contrast adjacent levels. Flip sign of 
# coefficient contrast 3 vs 6 to interpret slope.
pupilAXCPT$facLoad = factor(pupilAXCPT$Load, levels=c("6","3","9"))
pupilAXCPT$rMCI_cons_v2 = factor(pupilAXCPT$rMCI_cons_v2)
contr.backward.diff = matrix(c(-2/3, 1/3, 1/3,-1/3,-1/3,2/3), ncol = 2)
contrasts(pupilAXCPT$facLoad) = contr.backward.diff
pupilAXCPT$MZ = ifelse(pupilAXCPT$zyg14==1, 1, 0)
pupilAXCPT$site_v2rev = ifelse(pupilAXCPT$site_v2rev==1, 1, 0)
pupilAXCPT$Device = factor(pupilAXCPT$LR_Device)
pupilAXCPT$acamedbin = ifelse(pupilAXCPT$acamedtot==0, 0, 1)

#Bin MCI data into 0 = No impairment, 1 = Single domain MCI, 2 = Multi-domain MCI.
pupilAXCPT$rMCI_cons_bin = ifelse(pupilAXCPT$rMCI_cons_v2==0, 0, 
                                        ifelse(pupilAXCPT$rMCI_cons_v2==1 | 
                                               pupilAXCPT$rMCI_cons_v2==2, 1, 2))
pupilAXCPT$rMCI_cons_bin = factor(pupilAXCPT$rMCI_cons_bin)

# Center continuous variables to interpret intercept at mean value (rather than 0).
# Subject specific variables centered at subject level, trial specific variables centered at trial level.
contTrialVars = c("PCA","pctPCA","adjPCA")
contSubjVars = c("age_v2","afqtpcttran_v2","DSFMAX_v2","dprime")

# Center trial specific variables
for (x in contTrialVars) {
  newcol = paste0('c.',x)
  pupilAXCPT[[newcol]] = as.numeric(scale(pupilAXCPT[[x]], center=TRUE, scale=FALSE))
}

# Center subject specific variables
subjDF = pupilAXCPT[c("vetsaid",contSubjVars)]
subjDF %<>% group_by(vetsaid) %>% dplyr::summarise_each(funs(mean))
nums <- sapply(subjDF, is.numeric)
c.subjDF = as.data.frame(apply(subjDF[,nums],2, function(y) y - mean(y, na.rm=TRUE)))
names(c.subjDF) = paste0("c.",names(c.subjDF))
c.subjDF$vetsaid = subjDF$vetsaid
pupilAXCPT = left_join(pupilAXCPT, c.subjDF, by="vetsaid")

# Log transform BY RT measures
pupilAXCPT$log.bymeanrt = log(pupilAXCPT$bymeanrt)
pupilAXCPT$log.bymedianrt = log(pupilAXCPT$bymedianrt)
pupilAXCPT$log.bystdrt = log(pupilAXCPT$bystdrt)
pupilAXCPT$log.bycvrt = log(pupilAXCPT$bycvrt)

# Get BY RT standard deviation with mean RT regressed out
pupilAXCPT %<>%
  dplyr::select(vetsaid, bymeanrt, bystdrt) %>%
  group_by(vetsaid) %>%
  dplyr::summarise(bymeanrt = first(bymeanrt),
                   bystdrt = first(bystdrt)) %>%
  do(data.frame(vetsaid = .[["vetsaid"]],
                resid.bystdrt = resid(lm(bystdrt ~ bymeanrt, data=.)))) %>%
  inner_join(pupilAXCPT, by="vetsaid")

# Create quantile groups of log RT data
qVars = c("c.DSFMAX_v2","dprime","log.bymeanrt","log.bymedianrt",
          "log.bystdrt","log.bycvrt","resid.bystdrt")
new.qVars = qVars
names(new.qVars) = paste0("q.",qVars)
pupilAXCPT %<>%
  group_by(vetsaid) %>%
  dplyr::summarise_each_(funs(mean),qVars) %>%
  mutate_each_(funs(quantcut(.,q=4, labels=seq(1,4))),qVars) %>%
  dplyr::select_("vetsaid"="vetsaid",.dots=new.qVars) %>%
  inner_join(pupilAXCPT, by="vetsaid")

# Create residPCA by regressing BaselineDiameter from PCA and taking the residuals.
lme.PCA.resid = lmer(PCA ~ BaselineDiameter + (1 | case/vetsaid),data=pupilAXCPT)
pupilAXCPT$residPCA = resid(lme.PCA.resid)
```

# Basic sample descriptives
```{r, include=FALSE}
#Create dataset with subject level variables to assess relationships with BOLD variance.

subjDatAXCPT = pupilAXCPT %>% 
            dplyr::select(-contains("PCA"),-contains("Load")) %>%
            group_by(vetsaid) %>%
            summarise_each(funs(first))
```

How many subjects?
```{r}
n_distinct(subjDatAXCPT$vetsaid)
```

How many attrition replacements?
```{r}
dplyr::count(subjDatAXCPT, vetsa2)
```

How many twin pairs vs unpaired twins? 
```{r}
subjDatAXCPT %>%
  group_by(case) %>%
  dplyr::summarise(n_twins = n_distinct(vetsaid)) %>%
  dplyr::count(n_twins)
```


How many MZ and DZ pairs? (excludes unpaired subjects)
```{r}
subjDatAXCPT %>% 
  group_by(case) %>%
  mutate(n_twins = n_distinct(vetsaid)) %>%
  filter(n_twins > 1) %>%
  dplyr::summarise(zyg = mean(zyg14)) %>%
  group_by(zyg) %>%
  dplyr::count(zyg)
```

How many levels of load did subjects complete? Shows number of subjects who completed 1, 2, or 3 levels (corresponding to digit spans of 3, 6, and 9).
```{r}
pupilAXCPT %>%
  group_by(vetsaid) %>%
  dplyr::summarise(load = n()) %>%
  dplyr::count(load)
```

How many of each MCI group?
```{r}
dplyr::count(subjDatAXCPT, rMCI_cons_v2)
```

How many of each MCI group binned by single or multi-doman MCI?
```{r}
dplyr::count(subjDatAXCPT, rMCI_cons_bin)
```

Look at frequencies of MCI measures
```{r}
mci.p1 = sjp.frq(subjDatAXCPT$rMCI_cons_v2, 
          title="MCI groups",
          axisLabels.x=c("Normal","Single Domain\nNon-amnestic",
                         "Single Domain\nAmnestic","Multi Domain\nNon-Amnestic",
                         "Multi Domain Amnestic"),
          axisLimits.y = c(0,850))

mci.p2 = sjp.frq(subjDatAXCPT$rMCI_cons_bin, 
          title="Binned MCI groups",
          axisLabels.x=c("Normal","Single Domain MCI","Multi Domain MCI"),
          axisLimits.y = c(0,850))

grid.arrange(mci.p1$plot,mci.p2$plot)
```

```{r, include=FALSE}
pdf("K:/AX-CPT/results/MCI_groups.pdf", width=8, height=6)
grid.arrange(mci.p1$plot,mci.p2$plot)
dev.off()
```


Plot pctPCA and residPCA data to check for ceiling effects on pupil dilation
```{r}
pctPcaPlot = ggplot(pupilAXCPT, aes(x=pctPCA)) + 
  geom_histogram(fill="steel blue",color="black") + 
  facet_wrap(~ Load, nrow=3) + 
  ggtitle("Histogram of pctPCA by Load") + 
  xlab("% PCA") + theme_bw() 

residPcaPlot = ggplot(pupilAXCPT, aes(x=residPCA)) + 
  geom_histogram(fill="steel blue",color="black") + 
  facet_wrap(~ Load, nrow=3) + 
  ggtitle("Histogram of residPCA by Load") + 
  xlab("PCA (adjusted for baseline)") + theme_bw() 

grid.arrange(pctPcaPlot, residPcaPlot, ncol=2)
```

```{r, include=FALSE}
pdf("K:/AX-CPT/results/PCAxLoad.pdf")
grid.arrange(pctPcaPlot, residPcaPlot, ncol=2)
dev.off()
```

--------------------------------------------------

# AX-CPT performance 

## Error Rates

d' by MCI group
```{r}
dprime.p1 = ggplot(subjDatAXCPT, aes(x=dprime)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw(14)

dprime.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=dprime)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw(14)
g.dprime = grid.arrange(dprime.p1,dprime.p2, ncol=2, top="d' by MCI status")
summary(lm(dprime ~ rMCI_cons_bin, data=subjDatAXCPT))
```

AX False alarm rates
```{r}
axfa.p1 = ggplot(subjDatAXCPT, aes(x=axfarate)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw(14)

axfa.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=axfarate)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw(14)
g.ax = grid.arrange(axfa.p1, axfa.p2, ncol=2, top="AX FA Rate by MCI status")
summary(lm(axfarate ~ rMCI_cons_bin, data=subjDatAXCPT))
```

BX False alarm rates
```{r}
bxfa.p1 = ggplot(subjDatAXCPT, aes(x=bxfarate)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw(14)

bxfa.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=bxfarate)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw(14)
g.bx = grid.arrange(bxfa.p1, bxfa.p2, ncol=2, top="BX FA Rate by MCI status")
summary(lm(bxfarate ~ rMCI_cons_bin, data=subjDatAXCPT))
```

AY False alarm rates
```{r}
ayfa.p1 = ggplot(subjDatAXCPT, aes(x=ayfarate)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw(14)

ayfa.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=ayfarate)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw(14)
g.ay = grid.arrange(ayfa.p1, ayfa.p2, ncol=2, top="AY FA Rate by MCI status")
summary(lm(ayfarate ~ rMCI_cons_bin, data=subjDatAXCPT))
```

```{r,include=FALSE}
pdf("K:/AX-CPT/results/AX-CPTperformance_X_MCI.pdf", width=16,height=12)
grid.arrange(g.dprime,g.ax,g.bx,g.ay, ncol=2,top="AX-CPT Performance by MCI status")
dev.off()
```

## Reaction Times

BY mean reaction time
```{r}
log.bymeanrt.p1 = ggplot(subjDatAXCPT, aes(x=log.bymeanrt)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw()

log.bymeanrt.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=log.bymeanrt)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw()

grid.arrange(log.bymeanrt.p1, log.bymeanrt.p2, ncol=2, top="BY log mean RT by MCI status")
summary(lm(log.bymeanrt ~ rMCI_cons_bin, data=subjDatAXCPT))
```

BY median reaction time
```{r}
log.bymedianrt.p1 = ggplot(subjDatAXCPT, aes(x=log.bymedianrt)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw()

log.bymedianrt.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=log.bymedianrt)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw()

grid.arrange(log.bymedianrt.p1, log.bymedianrt.p2, ncol=2, 
             top="BY log median RT by MCI status")
summary(lm(log.bymedianrt ~ rMCI_cons_bin, data=subjDatAXCPT))
```


BY standard deviation reaction time
```{r}
log.bystdrt.p1 = ggplot(subjDatAXCPT, aes(x=log.bystdrt)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw()

log.bystdrt.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=log.bystdrt)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw()

grid.arrange(log.bystdrt.p1, log.bystdrt.p2, ncol=2, 
             top="BY log standard deviation RT by MCI status")
summary(lm(log.bystdrt ~ rMCI_cons_bin, data=subjDatAXCPT))
```

BY CV reaction time
```{r}
log.bycvrt.p1 = ggplot(subjDatAXCPT, aes(x=log.bycvrt)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw()

log.bycvrt.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=log.bycvrt)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw()

grid.arrange(log.bycvrt.p1, log.bycvrt.p2, ncol=2, top="BY log CV RT by MCI status")
summary(lm(log.bycvrt ~ rMCI_cons_bin, data=subjDatAXCPT))
```

BY residual standard deviation reaction time
```{r}
resid.bystdrt.p1 = ggplot(subjDatAXCPT, aes(x=resid.bystdrt)) + 
  geom_histogram(fill="steel blue",color="black") + 
  theme(plot.title=element_text(face="bold")) + theme_bw()

resid.bystdrt.p2 = ggplot(subjDatAXCPT, aes(x=rMCI_cons_bin,y=resid.bystdrt)) + 
              geom_boxplot(fill="firebrick",alpha=.75) +
              geom_jitter(alpha=0.3,position=position_jitter(width = 0.1)) +
              theme(plot.title=element_text(face="bold")) +
              theme_bw()

grid.arrange(resid.bystdrt.p1, resid.bystdrt.p2, ncol=2, 
             top="BY residual standard deviation RT by MCI status")
summary(lm(resid.bystdrt ~ rMCI_cons_bin, data=subjDatAXCPT))
```


```{r, include=FALSE}
# Save out figure of mean, std, and residual std RT
pdf("K:/AX-CPT/results/BY_RTxMCI.pdf", height=8, width=6)
grid.arrange(log.bymeanrt.p1, log.bymeanrt.p2, log.bystdrt.p1, log.bystdrt.p2,
             resid.bystdrt.p1, resid.bystdrt.p2, ncol=2)
dev.off()
```

# Mixed Effects Models: Cognitively normal only

## AX-CPT Performance
Plot pupil dilation by d' quantile
```{r, echo=FALSE}
summaryResidPCA.dprime = summarySEwithin(subset(pupilAXCPT, rMCI_cons_bin==0), 
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load",
                betweenvars="q.dprime",
                na.rm=TRUE)
  
p.dprime = summaryResidPCA.dprime %>%
          filter(q.dprime==1 | q.dprime==4) %>%
          ggplot(., aes(x=Load,y=residPCA,
                        color=q.dprime,
                        group=q.dprime)) +
            geom_line() +
            geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
            ggtitle("d'") + theme_bw(16) +
            ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
            scale_color_discrete(name="d-prime\nquantile",
                                 labels=c("Lower","Upper"))
print(p.dprime)
ggsave("K:/AX-CPT/results/pupil_dprime.pdf",p.dprime)
```

Run basic model testing interaction of Load with d'
```{r}
contrasts.facLoad.dprime = rbind(
    'Load3:c.dprime vs Load6:c.dprime' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0),
    'Load6:c.dprime vs Load9:c.dprime' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0),
    'Load3:c.dprime vs Load9:c.dprime' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0)
)
lme.facLoad.dprime = lmer(residPCA ~ facLoad*(c.dprime + c.DSFMAX_v2) + 
                            apoe4 + c.age_v2 + site_v2rev + Device + 
                            acamedbin + c.afqtpcttran_v2 + 
                            (1 | case/vetsaid), 
                            data=subset(pupilAXCPT, rMCI_cons_bin==0))
summary(lme.facLoad.dprime)
summary(glht(lme.facLoad.dprime, contrasts.facLoad.dprime), 
              test = adjusted("none"))
```

Test for differences based on d' within each level of Load
```{r}
lme.dprime.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ c.dprime + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), 
                    data=filter(pupilAXCPT,rMCI_cons_bin==0 & Load==x))
})
lapply(lme.dprime.loads, summary)
```

## Reaction Time Measures

**Mean RT**
Plot pupil dilation by mean RT quantile
```{r, echo=FALSE}
summaryResidPCA.log.bymeanrt = summarySEwithin(subset(pupilAXCPT, rMCI_cons_bin==0), 
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load",
                betweenvars="q.log.bymeanrt",
                na.rm=TRUE)
  
p.log.bymeanrt = summaryResidPCA.log.bymeanrt %>%
          filter(q.log.bymeanrt==1 | q.log.bymeanrt==4) %>%
          ggplot(., aes(x=Load,y=residPCA,
                        color=q.log.bymeanrt,
                        group=q.log.bymeanrt)) +
            geom_line() +
            geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
            ggtitle("Log Mean RT") + theme_bw(16) +
            ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
            scale_color_discrete(name="Mean RT\nquantile",
                                 labels=c("Lower","Upper"))
print(p.log.bymeanrt)
```


Run basic model testing interaction of Load with log mean RT
```{r}
contrasts.facLoad.log.bymeanrt = rbind(
    'Load3:log.bymeanrt vs Load6:log.bymeanrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0),
    'Load6:log.bymeanrt vs Load9:log.bymeanrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0),
    'Load3:log.bymeanrt vs Load9:log.bymeanrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0)
)
lme.facLoad.log.bymeanrt = lmer(residPCA ~ facLoad*(log.bymeanrt + c.DSFMAX_v2) +
                                apoe4 + c.age_v2 + site_v2rev + Device +
                                acamedbin + c.afqtpcttran_v2 + 
                                (1 | case/vetsaid), 
                                data=subset(pupilAXCPT, rMCI_cons_bin==0))
summary(lme.facLoad.log.bymeanrt)
summary(glht(lme.facLoad.log.bymeanrt, contrasts.facLoad.log.bymeanrt), 
              test = adjusted("none"))
```

Test for differences based on mean RT within each level of Load
```{r}
lme.log.bymeanrt.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ log.bymeanrt + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), 
                    data=filter(pupilAXCPT,rMCI_cons_bin==0 & Load==x))
})
lapply(lme.log.bymeanrt.loads, summary)
```

**Standard Deviation**
Plot pupil dilation by log standard deviation of RT quantile
```{r, echo=FALSE}
summaryResidPCA.log.bystdrt = summarySEwithin(subset(pupilAXCPT, rMCI_cons_bin==0),
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load",
                betweenvars="q.log.bystdrt",
                na.rm=TRUE)
  
p.log.bystdrt = summaryResidPCA.log.bystdrt %>%
          filter(q.log.bystdrt==1 | q.log.bystdrt==4) %>%
          ggplot(., aes(x=Load,y=residPCA,
                        color=q.log.bystdrt,
                        group=q.log.bystdrt)) +
            geom_line() +
            geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
            ggtitle("Log Standard Deviation RT") + theme_bw(16) +
            ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
            scale_color_discrete(name="SD RT\nquantile", 
                                 labels=c("Lower","Upper"))
print(p.log.bystdrt)
```

Run basic model testing interaction of Load with log std RT
```{r}
contrasts.facLoad.log.bystdrt = rbind(
    'Load3:log.bystdrt vs Load6:log.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0),
    'Load6:log.bystdrt vs Load9:log.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0),
    'Load3:log.bystdrt vs Load9:log.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0)
)
lme.facLoad.log.bystdrt = lmer(residPCA ~ facLoad*(log.bystdrt + c.DSFMAX_v2) +
                               apoe4 + c.age_v2 + site_v2rev + Device + 
                               acamedbin + c.afqtpcttran_v2 + 
                               (1 | case/vetsaid), 
                               data=subset(pupilAXCPT, rMCI_cons_bin==0))
summary(lme.facLoad.log.bystdrt)
summary(glht(lme.facLoad.log.bystdrt, contrasts.facLoad.log.bystdrt), 
              test = adjusted("none"))
```

Test for differences based on SD RT within each level of Load
```{r}
lme.log.bystdrt.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ log.bystdrt + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), 
                    data=filter(pupilAXCPT,rMCI_cons_bin==0 & Load==x))
})
lapply(lme.log.bystdrt.loads, summary)
```

**Residual Standard Deviation**
Plot pupil dilation by residual standard deviation of RT quantile
```{r, echo=FALSE}
summaryResidPCA.resid.bystdrt = summarySEwithin(subset(pupilAXCPT, rMCI_cons_bin==0), 
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load",
                betweenvars="q.resid.bystdrt",
                na.rm=TRUE)
  
p.resid.bystdrt = summaryResidPCA.resid.bystdrt %>%
          filter(q.resid.bystdrt==1 | q.resid.bystdrt==4) %>%
          ggplot(., aes(x=Load,y=residPCA,
                        color=q.resid.bystdrt,
                        group=q.resid.bystdrt)) +
            geom_line() +
            geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
            ggtitle("Residual Standard Deviation RT") + theme_bw(16) +
            ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
            scale_color_discrete(name="SD RT\nquantile", 
                                 labels=c("Lower","Upper"))
print(p.resid.bystdrt)
```

Run basic model testing interaction of Load with residual std RT
```{r}
contrasts.facLoad.resid.bystdrt = rbind(
    'Load3:resid.bystdrt vs Load6:resid.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0),
    'Load6:resid.bystdrt vs Load9:resid.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0),
    'Load3:resid.bystdrt vs Load9:resid.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0)
)
lme.facLoad.resid.bystdrt = lmer(residPCA ~ facLoad*(resid.bystdrt + c.DSFMAX_v2)
                                 + apoe4 + c.age_v2 + site_v2rev + Device +
                                 acamedbin + c.afqtpcttran_v2 + 
                                 (1 | case/vetsaid), 
                                  data=subset(pupilAXCPT, rMCI_cons_bin==0))
summary(lme.facLoad.resid.bystdrt)
summary(glht(lme.facLoad.resid.bystdrt, contrasts.facLoad.resid.bystdrt), 
              test = adjusted("none"))
```

Test for differences based on residual SD RT within each level of Load
```{r}
lme.resid.bystdrt.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ resid.bystdrt + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), 
                    data=filter(pupilAXCPT,rMCI_cons_bin==0 & Load==x))
})
lapply(lme.resid.bystdrt.loads, summary)
```

```{r, include=FALSE}
# Save plots of pupil response by reaction time measures
legend = get_legend(p.log.bymeanrt)
p.log.bymeanrt = p.log.bymeanrt + theme(legend.position="none")
p.log.bystdrt = p.log.bystdrt + theme(legend.position="none")
p.resid.bystdrt = p.resid.bystdrt + theme(legend.position="none")
pdf("K:/AX-CPT/results/pupil_rtmeasures.pdf",width=12,height=10)
grid.arrange(p.log.bymeanrt,p.log.bystdrt,p.resid.bystdrt,legend)
dev.off()
```

----------------
# Mixed Effects Models: All MCI groups

Run basic model testing interaction of Load with log mean RT
```{r}
contrasts.facLoad.log.bymeanrt.MCI = rbind(
    'Load3:log.bymeanrt vs Load6:log.bymeanrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,0),
    'Load6:log.bymeanrt vs Load9:log.bymeanrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0),
    'Load3:log.bymeanrt vs Load9:log.bymeanrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0,0,0,0,0)
)

lme.facLoad.log.bymeanrt.MCI = lmer(residPCA ~ facLoad*log.bymeanrt + apoe4 +
                                   c.age_v2 + site_v2rev + Device + acamedbin +
                                   facLoad*c.DSFMAX_v2 + facLoad*rMCI_cons_bin +
                                   c.afqtpcttran_v2 + (1 | case/vetsaid), 
                                data=pupilAXCPT)
summary(lme.facLoad.log.bymeanrt.MCI)
summary(glht(lme.facLoad.log.bymeanrt.MCI, 
             contrasts.facLoad.log.bymeanrt.MCI),
             test = adjusted("none"))
```

Test for differences based on mean RT within each level of Load
```{r}
lme.log.bymeanrt.loads.MCI <- lapply(loads, function(x) {
    lmer(residPCA ~ log.bymeanrt + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + 
                    rMCI_cons_bin + c.afqtpcttran_v2 + 
                    (1 | case), 
         data=filter(pupilAXCPT, Load==x))
})
lapply(lme.log.bymeanrt.loads.MCI, summary)
```

Run basic model testing interaction of Load with log std RT
```{r}
contrasts.facLoad.log.bystdrt.MCI = rbind(
    'Load3:log.bystdrt vs Load6:log.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,0),
    'Load6:log.bystdrt vs Load9:log.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0),
    'Load3:log.bystdrt vs Load9:log.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0,0,0,0,0)
)

lme.facLoad.log.bystdrt.MCI = lmer(residPCA ~ facLoad*log.bystdrt + apoe4 +
                                   c.age_v2 + site_v2rev + Device + acamedbin +
                                   facLoad*c.DSFMAX_v2 + facLoad*rMCI_cons_bin +
                                   c.afqtpcttran_v2 + (1 | case/vetsaid), 
                                data=pupilAXCPT)
summary(lme.facLoad.log.bystdrt.MCI)
summary(glht(lme.facLoad.log.bystdrt.MCI, 
             contrasts.facLoad.log.bystdrt.MCI),
             test = adjusted("none"))
```

Test for differences based on SD RT within each level of Load
```{r}
lme.log.bystdrt.loads.MCI <- lapply(loads, function(x) {
    lmer(residPCA ~ log.bystdrt + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + 
                    rMCI_cons_bin + c.afqtpcttran_v2 + 
                    (1 | case), 
                  data=filter(pupilAXCPT, Load==x))
})
lapply(lme.log.bystdrt.loads.MCI, summary)
```

Run basic model testing interaction of Load with residual std RT
```{r}
contrasts.facLoad.resid.bystdrt.MCI = rbind(
    'Load3:resid.bystdrt vs Load6:resid.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,0),
    'Load6:resid.bystdrt vs Load9:resid.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0),
    'Load3:resid.bystdrt vs Load9:resid.bystdrt' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0,0,0,0,0,0)
)

lme.facLoad.resid.bystdrt.MCI = lmer(residPCA ~ facLoad*resid.bystdrt + apoe4 +
                                   c.age_v2 + site_v2rev + Device + acamedbin +
                                   facLoad*c.DSFMAX_v2 + facLoad*rMCI_cons_bin +
                                   c.afqtpcttran_v2 + (1 | case/vetsaid), 
                                  data=pupilAXCPT)
summary(lme.facLoad.resid.bystdrt.MCI)
summary(glht(lme.facLoad.resid.bystdrt.MCI, 
             contrasts.facLoad.resid.bystdrt.MCI),
             test = adjusted("none"))
```

Test for differences based on residual SD RT within each level of Load
```{r}
lme.resid.bystdrt.loads.MCI <- lapply(loads, function(x) {
    lmer(residPCA ~ resid.bystdrt + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + 
                    rMCI_cons_bin + c.afqtpcttran_v2 + 
                    (1 | case), 
                    data=filter(pupilAXCPT, Load==x))
})
lapply(lme.resid.bystdrt.loads.MCI, summary)
```
----------------
# Covariate Plot 

Plot pupil dilation by digit span max quantile
```{r, echo=FALSE}
summaryResidPCA.DSFMAX_v2 = summarySEwithin(pupilAXCPT, 
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load",
                betweenvars="q.c.DSFMAX_v2",
                na.rm=TRUE)
  
p.DSFMAX_v2 = summaryResidPCA.DSFMAX_v2 %>%
          filter(q.c.DSFMAX_v2==1 | q.c.DSFMAX_v2==4) %>%
          ggplot(., aes(x=Load,y=residPCA,
                        color=q.c.DSFMAX_v2,
                        group=q.c.DSFMAX_v2)) +
            geom_line() +
            geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
            ggtitle("Max digit span") + theme_bw(16) +
            ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
            scale_color_discrete(name="Max digit span\nquantile",
                                 labels=c("Lower","Upper"))
print(p.DSFMAX_v2)
ggsave("K:/AX-CPT/results/pupil_MaxDigitSpan.pdf", p.DSFMAX_v2)
```

Plot pupil dilation by digit span max quantile
```{r, echo=FALSE}
summaryResidPCA.MCI = summarySEwithin(pupilAXCPT, 
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load",
                betweenvars="rMCI_cons_bin",
                na.rm=TRUE)
  
p.MCI = summaryResidPCA.MCI %>%
          ggplot(., aes(x=Load,y=residPCA,
                        color=rMCI_cons_bin,
                        group=rMCI_cons_bin)) +
            geom_line() +
            geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
            ggtitle("MCI Status") + theme_bw(16) +
            ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
            scale_color_discrete(name="MCI Group", 
                                 labels=c("No MCI",
                                          "Single Domain MCI",
                                          "Multi-Domain MCI"))
print(p.MCI)
ggsave("K:/AX-CPT/results/pupil_MCI.pdf", p.MCI)

```

----------------------------
```{r, include=FALSE}
#Save out analysis dataset
write.csv(pupilAXCPT, "K:/AX-CPT/data/pupilDS_AX-CPT_AnalysisDataset.csv")
```

```{r}
print(sessionInfo(), locale = FALSE)
```